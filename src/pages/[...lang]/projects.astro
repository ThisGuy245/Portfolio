---
import Nav from '../../components/Nav.astro';
import Layout from '../../layouts/Layout.astro';
import ProjectCard from '../../components/ProjectCard.astro';
import { languages } from '../../i18n/ui';
import { getLangFromUrl, useTranslations } from '../../i18n/utils';

export async function getStaticPaths() {
    return languages.map(lang => ({
        params: { lang: lang.key },
        props: { lang: lang.key }
    }));
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

interface Project {
    title: string;
    body: string;
    href: string;
    placeholderImg?: string;
    videoSrc?: string;
    category: string;
    teamSize?: number;
    technologies: string[];
    websiteUrl?: string;
}

// Map technology names to icon paths
function getTechIcons(technologies: string[]): string[] {
    const iconMap: Record<string, string> = {
        'c++': '/devIcons/Cpp.svg',
        'cpp': '/devIcons/Cpp.svg',
        'c#': '/devIcons/CSharp.svg',
        'csharp': '/devIcons/CSharp.svg',
        'python': '/devIcons/Python.svg',
        'javascript': '/devIcons/JS.svg',
        'typescript': '/devIcons/TypeScript.svg',
        'unreal': '/devIcons/Unreal.svg',
        'unity': '/devIcons/Unity.svg',
        'opengl': '/devIcons/SDL.svg',
        'sdl2': '/devIcons/SDL.svg',
        'astro': '/devIcons/Astro.svg',
        'Astro.svg': '/devIcons/Astro.svg',
        'svelte': '/devIcons/Svelte.svg',
        'Svelte': '/devIcons/Svelte.svg',
        'html': '/devIcons/HTML.svg',
        'css': '/devIcons/CSS.svg',
        'ai': '/devIcons/Python.svg', // Fallback for AI
    };

    return technologies
        .map(tech => iconMap[tech.toLowerCase()] || null)
        .filter((icon): icon is string => icon !== null);
}

const projects: Project[] = [
    {
        title: t('Game Studio Project'),
        body: t('GSPdesc'),
        href: `/${lang}/gamestudio`,
        videoSrc: '/media/gsp.mp4',
        category: t('Games Programming'),
        teamSize: 8,
        technologies: ['c++', 'unreal', 'unity']
    },
    {
        title: t('BFX Fest Game Jam'),
        body: t('BFXdesc'),
        href: `/${lang}/projects`,
        videoSrc: '/media/bfx.mp4',
        category: t('Games Programming'),
        teamSize: 5,
        technologies: ['c#', 'unity']
    },
    {
        title: t('Physics/Render Engine'),
        body: t('3GPdesc'),
        href: `/${lang}/projects`,
        placeholderImg: '/media/Date.png',
        category: t('Games Programming'),
        teamSize: 1,
        technologies: ['c++', 'opengl', 'sdl2']
    },
    {
        title: t('Web Invaders Game'),
        body: t('JE3desc'),
        href: `/${lang}/projects`,
        videoSrc: '/media/je3.mp4',
        category: t('Games Programming'),
        websiteUrl: "https://game.je3.com/",
        teamSize: 1,
        technologies: ['javascript', 'html', 'css']
    },
    {
        title: t('Guesthouse Site'),
        body: t('BZHdesc'),
        href: `/${lang}/projects`,
        placeholderImg: '/media/Domaine.jpg',
        category: t('Web Programming'),
        websiteUrl: "https://le-domaine.fr/en-GB/",
        teamSize: 1,
        technologies: ['Astro.svg', 'Svelte', 'typescript']
    },
    {
        title: t('Portfolio Website'),
        body: t('Portdesc'),
        href: `/${lang}/projects`,
        placeholderImg: '/media/Portfolio.jpg',
        category: t('Web Programming'),
        websiteUrl: "https://thomasisherwood.com/en/",
        teamSize: 1,
        technologies: ['astro', 'svelte', 'typescript']
    },
    /*
    {
        title: t('studio Project OST'),
        body: t('Coming Soon tracks produced on Logic X Pro for an upcoming project.'),
        href: `/${lang}/building`,
        placeholderImg: '/path/to/music-placeholder.jpg',
        category: t('Sound Engineering'),
        technologies: ['logicpro']
    },*/
    {
        title: t('AI Game Engine'),
        body: t('Enginedesc'),
        href: `/${lang}/aigameengine`,
        placeholderImg: '/media/Test.png',
        category: t('Games Programming'),
        teamSize: 1,
        technologies: ['c++', 'ai']
    },
    /*
    {
        title: t('Mobile Map Application'),
        body: t('A mobile application for rating locations, built with Flutter and Dart, using Firebase for online storage.'),
        href: `/${lang}/building`,
        placeholderImg: '/media/mobile-rating-app.jpg',
        category: t('Web Programming'),
        teamSize: 1,
        technologies: ['flutter', 'dart', 'firebase']
    }*/
];

// Categorizing projects by type (Games, Web, Music, etc.)
function categorizeProjects(projects: Project[]): Record<string, Project[]> {
    return projects.reduce((acc: Record<string, Project[]>, project: Project) => {
        const { category } = project;
        if (!acc[category]) {
            acc[category] = [];
        }
        acc[category].push(project);
        return acc;
    }, {});
}

// Filter functionality
let selectedCategory: string = t('All');

function filterProjects(category: string, projects: Project[]): Project[] {
    selectedCategory = category;
    if (category === t('All')) {
        return projects;
    } else {
        return projects.filter(project => project.category === category);
    }
}

let filteredProjects: Project[] = filterProjects(selectedCategory, projects);
---

<Layout title={`${t('Projects')} - Thomas Isherwood`}>
    <Nav lang={lang} />
    <main class="projects-page">
        <div class="container">
            <header class="page-header">
                <h1>{t('Projects')}</h1>
                <p class="page-subtitle">A selection of my recent work</p>
            </header>

            <!-- Projects Section -->
            <section id="projects">
                {Object.entries(categorizeProjects(filteredProjects)).map(([category, projects]) => (
                        <div class="category-section">
                            <h2 class="category-header">{category}</h2>
                            <ul class="project-cards">
                                {projects.map(project => (
                                        <li>
                                            <ProjectCard project={{
                                                ...project,
                                                icons: getTechIcons(project.technologies)
                                            }} />
                                        </li>
                                ))}
                            </ul>
                        </div>
                ))}
            </section>
        </div>
    </main>
</Layout>

<style>
    .projects-page {
        padding: var(--space-2xl) 0;
        min-height: calc(100vh - 80px);
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 var(--space-md);
    }

    .page-header {
        text-align: center;
        margin-bottom: var(--space-2xl);
    }

    .page-header h1 {
        font-size: clamp(2.5rem, 5vw, 3.5rem);
        font-weight: 700;
        margin: 0 0 var(--space-sm);
        letter-spacing: -0.03em;
    }

    .page-subtitle {
        font-size: 1.25rem;
        color: var(--color-text-muted);
        margin: 0;
    }

    .category-section {
        margin-bottom: var(--space-2xl);
    }

    .category-header {
        font-size: clamp(1.75rem, 4vw, 2.25rem);
        font-weight: 600;
        text-align: center;
        color: var(--color-text);
        margin: 0 0 var(--space-xl);
        letter-spacing: -0.02em;
    }

    .project-cards {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--space-lg);
        list-style: none;
        padding: 0;
        margin: 0;
    }

    @media (min-width: 640px) {
        .project-cards {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (min-width: 1024px) {
        .project-cards {
            grid-template-columns: repeat(3, 1fr);
        }
    }
</style>